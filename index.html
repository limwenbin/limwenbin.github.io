<!DOCTYPE html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body {
  margin: 0;
  overflow: hidden;
}

circle {
  stroke: #fff;
  stroke-width: 1.5px;
}

circle[mode="collasped"] {
  stroke: #999;
  stroke-width: 1.5px;
}
 .link {
  stroke: #999;
  stroke-opacity: .6;
  position: absolute;
  z-index: -1;
}

g {
  position: absolute;
  z-index: 1;
}

text{
  font-family: "Helvetica", sans-serif; font-size: 12px;
}

text[node_id="0"] {
  font-size: 30px;
  fill: white;
  text-anchor: middle;
}

</style>
<body>
<script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
<script>

var root;
var color = d3.scale.category10();
var force = d3.layout.force()
  .on("tick", tick);
var svg = d3.select("body").append("svg")

var link_container = svg.append("g");
var node_container = svg.append("g");

var link = link_container.selectAll(".link");
var gnode = node_container.selectAll(".gnode");

d3.json("wenbin.json", function(error, graph) {
  if (error) throw error;

  root = graph;
  root._nodes = [];
  root._links = [];
  update();
});

function update() {
  force
    .nodes(root.nodes.filter(function (d) { return d.visible > 0; }))
    .links(root.links.filter(function (d) { return d.visible > 0; }))
    .linkDistance( function(d) { return 40 + d.source.r + d.target.r; })
    .charge( function(d) { return d.node_id == 0 ? -1500: -500; })
    .start();

  // Create and update linkg g containers 
  link = link.data(root.links.filter(function (d) { return d.visible > 0; }));
    // , function(d) { return d.target.node_id; });
  link.exit().remove();  
  link.enter().append("line")
    .attr("class", "link")
    .attr("source", function(d) { return d.source; })
    .attr("target", function(d) { return d.target; })
    .style("stroke-width", function(d) { return Math.sqrt(d.value); });

  // Create and update node g containers 
  gnode = gnode.data(root.nodes.filter(function (d) { return d.visible > 0; })
    , function(d) { return d.node_id;});
  gnode.exit().remove();
  gnode.enter().append("g")
    .attr("class", "gnode")
    .attr("node_id", function(d) { return d.node_id; })
    .attr("type", function(d) { return d.type; })
    .on("click", click)
    .call(force.drag);

  // Create and update node and text elements
  gnode.selectAll(".circle").remove();
  node_container.selectAll(".gnode[type='node']").append("circle")
    .attr("class", "circle")
    .attr("mode", function(d) { return d.mode; })
    .attr("r", function(d) { return d.r; })
    .style("fill", function(d) { return color(d.group); });
  gnode.selectAll(".text").remove();
  node_container.selectAll(".gnode[type='node']").append("text")
    .attr("class", "text")
    .attr("node_id", function(d) { return d.node_id; })
    .attr("dx", function(d) { return d.node_id != 0 ? d.r + 2 : null; })
    .attr("dy", ".35em")
    .text(function(d) {return d.name;});

  // Create and update book elements
  gnode.selectAll(".book").remove();
  node_container.selectAll(".gnode[type='book']").append("svg:image")
    .attr("class", "book")
    .attr("node_id", function(d) { return d.node_id; })
    .attr("xlink:href", function(d) { return d.href; })
    .attr("x", "-25px")
    .attr("y", "-40px")
    .attr("width", "50")
    .attr("height", "80");

  resize();
  d3.select(window).on("resize", resize);
}

function tick() {
  link.attr("x1", function(d) { return d.source.x; })
      .attr("y1", function(d) { return d.source.y; })
      .attr("x2", function(d) { return d.target.x; })
      .attr("y2", function(d) { return d.target.y; });

  gnode.attr("transform", function(d) {
    return "translate(" + d.x + "," + d.y + ")";
  });
}

function resize() {
  width = window.innerWidth, height = window.innerHeight;
  svg.attr("width", width).attr("height", height);
  force.size([width, height]).resume();
}

// Figure out how to represent children in json data of "nodes".
function click(d,i) {
  if (d3.event.defaultPrevented) return;
  toggle_node(d,i);
  update();
}

function toggle_node(d,i) {
  if (d.mode == "expanded") {
    hide_children(i);
    d.mode = "collasped";
  }
  else if (d.mode == "collasped") {
    show_children(i);
    d.mode = "expanded";
  }
}

function hide_children(i) {
  for (var j = 0; j < root.links.length; j++) {
    if (root.links[j].source.node_id == i && root.links[j].type != "lateral") {
      var target_id = root.links[j].target.node_id;
      hide_children(target_id);
      root.nodes[target_id].visible -= 1;
      root.links[j].visible -= 1;
    }
    else if ((root.links[j].source.node_id == i || root.links[j].target.node_id == i)
      && root.links[j].type == "lateral") {
      root.links[j].visible -= 1;
    }
  }
}

function show_children(i) {
  for (var j = 0; j < root.links.length; j++) {
    if (root.links[j].source.node_id == i && root.links[j].type != "lateral") {
      var target_id = root.links[j].target.node_id;
      show_children(target_id);
      root.nodes[target_id].visible += 1;
      root.links[j].visible += 1;
    }
    else if ((root.links[j].source.node_id == i || root.links[j].target.node_id == i)
      && root.links[j].type == "lateral") {
      root.links[j].visible += 1;
    }
  }
}

</script>